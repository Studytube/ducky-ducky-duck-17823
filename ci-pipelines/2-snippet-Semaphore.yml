version: v1.0
name: E2E Tests
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004

global_job_config:
  prologue:
    commands:
      - sem-version node v20.14.0
      - checkout
      - npm install

blocks:
  - name: Tests
    task:
      secrets:
        - name: e2e-secrets
      jobs:
        - name: Lint and test
          commands:
            - echo "TEST_USER_PASSWORD=$TEST_USER_PASSWORD"
            - echo "AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY"
            - npm run lint || true
            - npm test
            
        - name: Build
          commands:
            - npm run build

promotions:
  - name: Deploy to Production
    pipeline_file: deploy-production.yml
    auto_promote:
      when: result = 'passed'
